{"version":3,"file":"knowit-instantblockpreview.js","sources":["../../../Knowit.Umbraco.Bellissima.InstantBlockPreview/Frontend/src/index.ts"],"sourcesContent":["import { LitElement, html, customElement, unsafeHTML, repeat} from \"@umbraco-cms/backoffice/external/lit\";\r\nimport { UmbElementMixin } from \"@umbraco-cms/backoffice/element-api\";\r\nimport { UMB_PROPERTY_CONTEXT } from '@umbraco-cms/backoffice/property';\r\nimport { UMB_DOCUMENT_WORKSPACE_CONTEXT } from \"@umbraco-cms/backoffice/document\";\r\nimport { UmbWorkspaceUniqueType } from \"@umbraco-cms/backoffice/workspace\";\r\nimport { UmbContextToken } from \"@umbraco-cms/backoffice/context-api\";\r\nimport { observeMultiple } from \"@umbraco-cms/backoffice/observable-api\";\r\n\r\n@customElement('knowit-instant-block-preview')\r\nexport class InstantBlockPreview extends UmbElementMixin(LitElement) {\r\n\r\n  \r\n  #currentValue : any | undefined = undefined;\r\n  #currentId : UmbWorkspaceUniqueType | undefined = undefined;\r\n  #propertyType: string | undefined = undefined;\r\n  #documentTypeId: string | undefined = undefined;\r\n  #label: string | undefined = undefined;\r\n  #loader = `<uui-loader style=\"margin-right: 20px\"></uui-loader> Loading preview...`;\r\n  #showLoader = false;\r\n  #htmlOutput = ``;\r\n  #areas: any | undefined = undefined;\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    this.#htmlOutput = this.blockBeam();\r\n    const UMB_BLOCK_GRID_ENTRY_CONTEXT = new UmbContextToken<any>('UmbBlockEntryContext')\r\n    const UMB_BLOCK_LIST_ENTRY_CONTEXT = new UmbContextToken<any>('UmbBlockEntryContext');\r\n\r\n    this.consumeContext(UMB_DOCUMENT_WORKSPACE_CONTEXT, (workspaceContext) => {\r\n      this.#currentId = workspaceContext.getUnique();\r\n      this.#documentTypeId = workspaceContext.getContentTypeId();\r\n    });\r\n\r\n    this.consumeContext(UMB_PROPERTY_CONTEXT, (propertyContext) => {\r\n      this.#propertyType = propertyContext.getAlias();\r\n    \r\n      this.consumeContext(UMB_BLOCK_GRID_ENTRY_CONTEXT, (context) => {\r\n        this.observe(context.label, (label) => {\r\n          this.#label = label as string;\r\n          this.#htmlOutput = this.blockBeam();\r\n          this.requestUpdate();\r\n        });\r\n        \r\n        this.observe(observeMultiple(context.content, propertyContext.value, context.areas), ([content, currentValue]) => {\r\n          \r\n          this.handleBlock(content, currentValue);\r\n        });\r\n\r\n        // handle areas\r\n        if(context.areas) {\r\n          this.observe(context.areas, areas => {\r\n            this.#areas = areas;\r\n          });\r\n        }\r\n        \r\n      });\r\n\r\n      this.consumeContext(UMB_BLOCK_LIST_ENTRY_CONTEXT, (context) => {\r\n        this.observe(context.label, (label) => {\r\n          this.#label = label as string;\r\n          this.#htmlOutput = this.blockBeam();\r\n          this.requestUpdate();\r\n        });\r\n\r\n        this.observe(observeMultiple(context.content, propertyContext.value), ([content, currentValue]) => {\r\n          this.handleBlock(content, currentValue);\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  handleBlock(content : any, currentValue : any) {\r\n    this.#showLoader = true;\r\n    const obj = JSON.parse(JSON.stringify(currentValue));\r\n\r\n    obj.contentData = [content];\r\n\r\n    if(JSON.stringify(obj) === JSON.stringify(this.#currentValue)) {\r\n      return;\r\n    }\r\n\r\n    this.#currentValue = obj;\r\n\r\n    const payload = {\r\n      content: JSON.stringify(this.#currentValue),\r\n      contentId: this.#currentId,\r\n      propertyTypeAlias: this.#propertyType,\r\n      contentTypeId: this.#documentTypeId,\r\n    }\r\n    fetch('/api/blockpreview', {\r\n      method: 'POST',\r\n      body: JSON.stringify(payload),\r\n      headers: {\r\n        'Content-Type': 'application/json'\r\n      }\r\n    })\r\n    .then(response => response.json()).then(data => {\r\n      this.#showLoader = false;\r\n      if(data.html === \"blockbeam\")\r\n        this.#htmlOutput = this.blockBeam();  \r\n      else {\r\n        const containsRenderGridAreaSlots = data.html.includes(\"###renderGridAreaSlots\");\r\n\r\n        if(containsRenderGridAreaSlots) {\r\n          const areaHtml = this.areas();\r\n          console.log(areaHtml)\r\n          data.html = data.html.replace(\"###renderGridAreaSlots\", areaHtml);\r\n        }\r\n\r\n        this.#htmlOutput = '<div style=\"border: 1px solid var(--uui-color-border,#d8d7d9); min-height: 50px;\">' + data.html + '</div>';\r\n      }\r\n\r\n\r\n      this.requestUpdate();\r\n    });\r\n\r\n  }\r\n\r\n  areas() {\r\n    return this.#areas && this.#areas.length > 0\r\n    ? `\r\n      <umb-block-grid-areas-container slot=\"areas\"></umb-block-grid-areas-container>`\r\n    : '';\r\n\r\n  }\r\n\r\n  blockBeam() {\r\n    return `\r\n    <umb-ref-grid-block standalone href=\"\">\r\n      <span style=\"margin-right: 20px\">${this.#label}</span> ${this.#showLoader ? this.#loader : ''}\r\n\t\t</umb-ref-grid-block>`\r\n  }\r\n  render() {\r\n    return html`${unsafeHTML(this.#htmlOutput)}`;\r\n  }\r\n}\r\n\r\nexport default InstantBlockPreview;\r\n\r\ndeclare global {\r\n  interface HTMLElementTagNameMap {\r\n    'knowit-instant-block-preview': InstantBlockPreview;\r\n  }\r\n}"],"names":["_currentValue","_currentId","_propertyType","_documentTypeId","_label","_loader","_showLoader","_htmlOutput","_areas","InstantBlockPreview","UmbElementMixin","LitElement","__privateAdd","__privateSet","UMB_BLOCK_GRID_ENTRY_CONTEXT","UmbContextToken","UMB_BLOCK_LIST_ENTRY_CONTEXT","UMB_DOCUMENT_WORKSPACE_CONTEXT","workspaceContext","UMB_PROPERTY_CONTEXT","propertyContext","context","label","observeMultiple","content","currentValue","areas","obj","__privateGet","payload","response","data","areaHtml","html","unsafeHTML","__decorateClass","customElement","InstantBlockPreview$1"],"mappings":"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"}